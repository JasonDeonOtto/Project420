@page "/pos/cancel"
@page "/pos/cancel/{TransactionNumber}"
@using Project420.Retail.POS.BLL.Services
@using Project420.Retail.POS.BLL.DTOs
@using Project420.Shared.Core.Enums
@inject ITransactionService TransactionService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Cancel Transaction</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Cancel Transaction</h2>
        <button class="btn btn-outline-secondary" @onclick="GoBack">
            Back to Transactions
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading transaction...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            <strong>Error:</strong> @errorMessage
        </div>
    }
    else
    {
        <!-- STEP 1: LOOKUP OR CONFIRM CART CANCELLATION -->
        @if (currentStep == CancellationStep.SelectType)
        {
            <div class="row">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">Cancel Before Payment</h5>
                        </div>
                        <div class="card-body">
                            <p>Use this option to clear the current cart before payment is processed.</p>
                            <ul class="text-muted">
                                <li>Customer changed their mind</li>
                                <li>Wrong items scanned</li>
                                <li>Need to start over</li>
                            </ul>
                            <p class="text-info small">
                                <strong>Note:</strong> No database changes - simply clears the cart.
                            </p>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-warning w-100" @onclick="SelectPrePaymentCancellation">
                                Clear Cart (Pre-Payment)
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">Cancel Completed Transaction</h5>
                        </div>
                        <div class="card-body">
                            <p>Use this option to void a completed transaction (after payment).</p>
                            <ul class="text-muted">
                                <li>Requires transaction number</li>
                                <li>Reverses stock movements</li>
                                <li>May require manager approval</li>
                            </ul>
                            <p class="text-danger small">
                                <strong>Warning:</strong> This will reverse inventory movements and may require a payment refund.
                            </p>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-danger w-100" @onclick="SelectPostPaymentCancellation">
                                Void Transaction (Post-Payment)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- STEP 2A: PRE-PAYMENT CANCELLATION (Cart Clear) -->
        @if (currentStep == CancellationStep.PrePaymentCancellation)
        {
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Pre-Payment Cancellation - Clear Cart</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Cancellation Reason *</label>
                        <select class="form-select" @bind="cancellationRequest.Reason">
                            <option value="@CancellationReason.CustomerRequest">Customer Changed Mind</option>
                            <option value="@CancellationReason.CashierError">Cashier Error - Wrong Item/Quantity</option>
                            <option value="@CancellationReason.PriceError">Price Error</option>
                            <option value="@CancellationReason.ProductUnavailable">Product Unavailable</option>
                            <option value="@CancellationReason.AgeVerificationFailed">Age Verification Failed</option>
                            <option value="@CancellationReason.ComplianceIssue">Compliance Issue</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" rows="3" @bind="cancellationRequest.Notes"
                                  placeholder="Additional details about the cancellation..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Cashier ID *</label>
                        <input type="number" class="form-control" @bind="cancellationRequest.ProcessedByUserId"
                               placeholder="Enter your user ID" />
                    </div>

                    <div class="alert alert-info">
                        <strong>What happens:</strong> The cart will be cleared. No database changes will be made.
                        You can start a new transaction immediately.
                    </div>
                </div>
                <div class="card-footer d-flex gap-2">
                    <button class="btn btn-warning" @onclick="ProcessPrePaymentCancellation" disabled="@isProcessing">
                        @if (isProcessing)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Confirm Clear Cart
                    </button>
                    <button class="btn btn-secondary" @onclick="GoBackToSelection">
                        Back
                    </button>
                </div>
            </div>
        }

        <!-- STEP 2B: POST-PAYMENT CANCELLATION - Lookup -->
        @if (currentStep == CancellationStep.LookupTransaction)
        {
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Step 1: Lookup Transaction to Cancel</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Transaction Number</label>
                                <input type="text" class="form-control" @bind="transactionNumberInput"
                                       @bind:event="oninput" @onkeypress="HandleLookupKeyPress"
                                       placeholder="SALE-20251214-001" />
                                <small class="text-muted">Enter the transaction number to cancel</small>
                            </div>
                            <button class="btn btn-danger" @onclick="LookupTransaction" disabled="@isLoading">
                                @if (isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Lookup Transaction
                            </button>
                            <button class="btn btn-secondary ms-2" @onclick="GoBackToSelection">
                                Back
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-warning">
                                <h6 class="alert-heading">Important:</h6>
                                <ul class="mb-0 small">
                                    <li>Transaction must be within 24 hours</li>
                                    <li>Completed transactions require manager approval</li>
                                    <li>Stock movements will be reversed</li>
                                    <li>Payment refund may be required</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- STEP 3: VERIFY ELIGIBILITY -->
        @if (currentStep == CancellationStep.VerifyEligibility && eligibility != null)
        {
            <div class="card mb-3">
                <div class="card-header @(eligibility.IsEligible ? "bg-success" : "bg-danger") text-white">
                    <h5 class="mb-0">
                        @if (eligibility.IsEligible)
                        {
                            <text>Transaction Eligible for Cancellation</text>
                        }
                        else
                        {
                            <text>Transaction NOT Eligible for Cancellation</text>
                        }
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Transaction Details -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <small class="text-muted d-block">Transaction #</small>
                                    <strong class="fs-6">@eligibility.TransactionNumber</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <small class="text-muted d-block">Date</small>
                                    <strong>@eligibility.TransactionDate.ToString("yyyy-MM-dd HH:mm")</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <small class="text-muted d-block">Status</small>
                                    <strong>@eligibility.Status</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <small class="text-muted d-block">Total</small>
                                    <strong class="text-success fs-5">R @eligibility.TotalAmount.ToString("F2")</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <small class="text-muted">Payment Method:</small>
                            <strong class="ms-2">@eligibility.PaymentMethod</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Items:</small>
                            <strong class="ms-2">@eligibility.ItemCount</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Time Since:</small>
                            <strong class="ms-2">
                                @if (eligibility.MinutesSinceTransaction < 60)
                                {
                                    <text>@eligibility.MinutesSinceTransaction minutes</text>
                                }
                                else
                                {
                                    <text>@(eligibility.MinutesSinceTransaction / 60) hours @(eligibility.MinutesSinceTransaction % 60) min</text>
                                }
                            </strong>
                        </div>
                    </div>

                    <!-- Items Table -->
                    @if (eligibility.Items.Any())
                    {
                        <h6 class="mt-3">Transaction Items</h6>
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>SKU</th>
                                    <th>Batch/SN</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-end">Unit Price</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in eligibility.Items)
                                {
                                    <tr>
                                        <td>@item.ProductName</td>
                                        <td><code>@item.ProductSku</code></td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(item.SerialNumber))
                                            {
                                                <small class="text-info">SN: @item.SerialNumber</small>
                                            }
                                            else if (!string.IsNullOrEmpty(item.BatchNumber))
                                            {
                                                <small>@item.BatchNumber</small>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td class="text-center">@item.Quantity</td>
                                        <td class="text-end">R @item.UnitPrice.ToString("F2")</td>
                                        <td class="text-end fw-bold">R @item.LineTotal.ToString("F2")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }

                    <!-- Warnings -->
                    @if (eligibility.Warnings.Any())
                    {
                        <div class="alert alert-warning mt-3">
                            <strong>Warnings:</strong>
                            <ul class="mb-0 mt-1">
                                @foreach (var warning in eligibility.Warnings)
                                {
                                    <li>@warning</li>
                                }
                            </ul>
                        </div>
                    }

                    <!-- Ineligibility Reasons -->
                    @if (eligibility.IneligibilityReasons.Any())
                    {
                        <div class="alert alert-danger mt-3">
                            <strong>Cannot Cancel:</strong>
                            <ul class="mb-0 mt-1">
                                @foreach (var reason in eligibility.IneligibilityReasons)
                                {
                                    <li>@reason</li>
                                }
                            </ul>
                        </div>
                    }

                    <!-- Manager Approval Required -->
                    @if (eligibility.RequiresManagerApproval)
                    {
                        <div class="alert alert-info mt-3">
                            <strong>Manager Approval Required:</strong> @eligibility.ManagerApprovalReason
                        </div>
                    }
                </div>
                <div class="card-footer d-flex gap-2">
                    @if (eligibility.IsEligible)
                    {
                        <button class="btn btn-danger" @onclick="ProceedToCancellation">
                            Proceed to Cancel
                        </button>
                    }
                    <button class="btn btn-secondary" @onclick="StartOver">
                        Start Over
                    </button>
                </div>
            </div>
        }

        <!-- STEP 4: CANCELLATION FORM -->
        @if (currentStep == CancellationStep.CancellationForm && eligibility != null)
        {
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Step 2: Complete Cancellation - @eligibility.TransactionNumber</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Cancellation Reason *</label>
                                <select class="form-select" @bind="cancellationRequest.Reason">
                                    <option value="@CancellationReason.CustomerRequest">Customer Changed Mind</option>
                                    <option value="@CancellationReason.CashierError">Cashier Error - Wrong Item/Quantity</option>
                                    <option value="@CancellationReason.PaymentFailed">Payment Declined/Failed</option>
                                    <option value="@CancellationReason.PriceError">Price Error</option>
                                    <option value="@CancellationReason.AgeVerificationFailed">Age Verification Failed</option>
                                    <option value="@CancellationReason.ProductUnavailable">Product Unavailable</option>
                                    <option value="@CancellationReason.DuplicateTransaction">Duplicate/Test Transaction</option>
                                    <option value="@CancellationReason.SystemError">System/Technical Error</option>
                                    <option value="@CancellationReason.ComplianceIssue">Compliance Issue</option>
                                    <option value="@CancellationReason.FraudSuspected">Fraud Suspected</option>
                                    <option value="@CancellationReason.ManagerOverride">Manager Override</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Notes/Explanation @(eligibility.RequiresManagerApproval ? "*" : "")</label>
                                <textarea class="form-control" rows="3" @bind="cancellationRequest.Notes"
                                          placeholder="Explain why this transaction is being cancelled..."></textarea>
                                @if (eligibility.RequiresManagerApproval)
                                {
                                    <small class="text-info">Required when manager approval needed</small>
                                }
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Cashier ID *</label>
                                <input type="number" class="form-control" @bind="cancellationRequest.ProcessedByUserId"
                                       placeholder="Enter your user ID" />
                            </div>
                        </div>

                        <div class="col-md-6">
                            @if (eligibility.RequiresManagerApproval)
                            {
                                <div class="card border-info mb-3">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">Manager Authorization Required</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted small">@eligibility.ManagerApprovalReason</p>

                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Manager User ID *</label>
                                            <input type="number" class="form-control" @bind="cancellationRequest.ManagerApprovalUserId"
                                                   placeholder="Manager ID" />
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Manager PIN *</label>
                                            <input type="password" class="form-control" @bind="cancellationRequest.ManagerPin"
                                                   placeholder="Enter 4-digit PIN" maxlength="10" />
                                            <small class="text-muted">PoC: Use PIN "1234"</small>
                                        </div>

                                        @if (managerValidated)
                                        {
                                            <div class="alert alert-success py-2">
                                                <small>Manager verified: @managerName</small>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(managerError))
                                        {
                                            <div class="alert alert-danger py-2">
                                                <small>@managerError</small>
                                            </div>
                                        }

                                        <button class="btn btn-outline-info btn-sm" @onclick="ValidateManager" disabled="@isValidatingManager">
                                            @if (isValidatingManager)
                                            {
                                                <span class="spinner-border spinner-border-sm me-2"></span>
                                            }
                                            Verify Manager
                                        </button>
                                    </div>
                                </div>
                            }

                            <!-- Cancellation Preview -->
                            <div class="card border-danger">
                                <div class="card-header bg-danger text-white">
                                    <h6 class="mb-0">Cancellation Preview</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm mb-0">
                                        <tr>
                                            <td>Transaction:</td>
                                            <td class="text-end"><strong>@eligibility.TransactionNumber</strong></td>
                                        </tr>
                                        <tr>
                                            <td>Items to Reverse:</td>
                                            <td class="text-end">@eligibility.ItemCount items</td>
                                        </tr>
                                        <tr>
                                            <td>Amount:</td>
                                            <td class="text-end text-danger fw-bold">R @eligibility.TotalAmount.ToString("F2")</td>
                                        </tr>
                                        @if (eligibility.Status == TransactionStatus.Completed)
                                        {
                                            <tr>
                                                <td>Payment Reversal:</td>
                                                <td class="text-end text-warning">Required (@eligibility.PaymentMethod)</td>
                                            </tr>
                                        }
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between">
                        <button class="btn btn-secondary" @onclick="() => currentStep = CancellationStep.VerifyEligibility">
                            Back
                        </button>
                        <button class="btn btn-danger btn-lg" @onclick="ProcessCancellation"
                                disabled="@(!CanProcessCancellation)">
                            @if (isProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            Confirm Cancellation
                        </button>
                    </div>
                </div>
            </div>
        }

        <!-- STEP 5: RESULT -->
        @if (currentStep == CancellationStep.Complete && cancellationResult != null)
        {
            <div class="card">
                <div class="card-header @(cancellationResult.Success ? "bg-success" : "bg-danger") text-white">
                    <h5 class="mb-0">
                        @if (cancellationResult.Success)
                        {
                            <text>Transaction Cancelled Successfully</text>
                        }
                        else
                        {
                            <text>Cancellation Failed</text>
                        }
                    </h5>
                </div>
                <div class="card-body">
                    @if (cancellationResult.Success)
                    {
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <small class="text-muted d-block">Transaction</small>
                                        <strong>@cancellationResult.TransactionNumber</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <small class="text-muted d-block">Cancelled At</small>
                                        <strong>@cancellationResult.CancellationDate.ToString("HH:mm:ss")</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <small class="text-muted d-block">Movements Reversed</small>
                                        <strong>@cancellationResult.MovementsReversed</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <small class="text-muted d-block">Reason</small>
                                        <strong>@cancellationResult.Reason</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @if (cancellationResult.RequiresPaymentReversal)
                        {
                            <div class="alert alert-warning">
                                <h6 class="alert-heading">Payment Reversal Required</h6>
                                <p class="mb-0">
                                    <strong>Amount:</strong> R @cancellationResult.RefundAmount?.ToString("F2")<br/>
                                    <strong>Original Payment:</strong> @cancellationResult.OriginalPaymentMethod
                                </p>
                                <hr/>
                                <p class="mb-0 small">
                                    Please process the payment reversal according to your store's procedures.
                                    For card payments, initiate a reversal through your terminal.
                                    For cash, return the amount to the customer.
                                </p>
                            </div>
                        }

                        <div class="alert alert-info">
                            <strong>Audit Trail:</strong> This cancellation has been logged with reason,
                            timestamp, and user information for compliance purposes.
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-danger">
                            <strong>Errors:</strong>
                            <ul class="mb-0 mt-1">
                                @foreach (var error in cancellationResult.ErrorMessages)
                                {
                                    <li>@error</li>
                                }
                            </ul>
                        </div>
                    }
                </div>
                <div class="card-footer d-flex gap-2">
                    <button class="btn btn-primary" @onclick="StartNewSale">
                        Start New Sale
                    </button>
                    <button class="btn btn-secondary" @onclick="StartOver">
                        Cancel Another Transaction
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="GoBack">
                        Back to Transactions
                    </button>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public string? TransactionNumber { get; set; }

    private enum CancellationStep
    {
        SelectType,
        PrePaymentCancellation,
        LookupTransaction,
        VerifyEligibility,
        CancellationForm,
        Complete
    }

    // State
    private CancellationStep currentStep = CancellationStep.SelectType;
    private bool isLoading = false;
    private bool isProcessing = false;
    private bool isValidatingManager = false;
    private string? errorMessage;

    // Input
    private string transactionNumberInput = string.Empty;

    // Data
    private CancellationEligibilityDto? eligibility;
    private CancellationResultDto? cancellationResult;
    private CancellationRequestDto cancellationRequest = new() { ProcessedByUserId = 1 };

    // Manager validation
    private bool managerValidated = false;
    private string? managerName;
    private string? managerError;

    protected override void OnInitialized()
    {
        // If transaction number provided in URL, go directly to lookup
        if (!string.IsNullOrWhiteSpace(TransactionNumber))
        {
            transactionNumberInput = TransactionNumber;
            currentStep = CancellationStep.LookupTransaction;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !string.IsNullOrWhiteSpace(TransactionNumber))
        {
            await LookupTransaction();
            StateHasChanged();
        }
    }

    private bool CanProcessCancellation
    {
        get
        {
            if (isProcessing) return false;
            if (cancellationRequest.ProcessedByUserId <= 0) return false;
            if (eligibility?.RequiresManagerApproval == true)
            {
                if (cancellationRequest.ManagerApprovalUserId == null) return false;
                if (string.IsNullOrEmpty(cancellationRequest.ManagerPin)) return false;
            }
            return true;
        }
    }

    // ========================================
    // NAVIGATION
    // ========================================

    private void SelectPrePaymentCancellation()
    {
        cancellationRequest = new CancellationRequestDto
        {
            IsPrePaymentCancellation = true,
            ProcessedByUserId = 1,
            Reason = CancellationReason.CustomerRequest
        };
        currentStep = CancellationStep.PrePaymentCancellation;
    }

    private void SelectPostPaymentCancellation()
    {
        cancellationRequest = new CancellationRequestDto
        {
            IsPrePaymentCancellation = false,
            ProcessedByUserId = 1,
            Reason = CancellationReason.CustomerRequest
        };
        currentStep = CancellationStep.LookupTransaction;
    }

    private void GoBackToSelection()
    {
        currentStep = CancellationStep.SelectType;
        ResetState();
    }

    private void StartOver()
    {
        ResetState();
        currentStep = CancellationStep.SelectType;
    }

    private void ResetState()
    {
        transactionNumberInput = string.Empty;
        eligibility = null;
        cancellationResult = null;
        cancellationRequest = new CancellationRequestDto { ProcessedByUserId = 1 };
        managerValidated = false;
        managerName = null;
        managerError = null;
        errorMessage = null;
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/pos/transactions");
    }

    private void StartNewSale()
    {
        Navigation.NavigateTo("/pos/checkout");
    }

    // ========================================
    // LOOKUP
    // ========================================

    private async Task HandleLookupKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LookupTransaction();
        }
    }

    private async Task LookupTransaction()
    {
        if (string.IsNullOrWhiteSpace(transactionNumberInput))
        {
            errorMessage = "Please enter a transaction number";
            return;
        }

        try
        {
            isLoading = true;
            errorMessage = null;

            eligibility = await TransactionService.ValidateCancellationEligibilityAsync(transactionNumberInput.Trim());

            if (eligibility != null)
            {
                cancellationRequest.TransactionNumber = transactionNumberInput.Trim();
                currentStep = CancellationStep.VerifyEligibility;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error looking up transaction: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ProceedToCancellation()
    {
        if (eligibility?.IsEligible != true) return;
        currentStep = CancellationStep.CancellationForm;
    }

    // ========================================
    // MANAGER VALIDATION
    // ========================================

    private async Task ValidateManager()
    {
        if (cancellationRequest.ManagerApprovalUserId == null || string.IsNullOrEmpty(cancellationRequest.ManagerPin))
        {
            managerError = "Please enter both Manager ID and PIN";
            managerValidated = false;
            return;
        }

        try
        {
            isValidatingManager = true;
            managerError = null;

            var result = await TransactionService.ValidateManagerPinAsync(
                cancellationRequest.ManagerApprovalUserId.Value,
                cancellationRequest.ManagerPin);

            if (result.IsValid)
            {
                managerValidated = true;
                managerName = result.ManagerName;
                managerError = null;
            }
            else
            {
                managerValidated = false;
                managerName = null;
                managerError = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            managerError = $"Validation error: {ex.Message}";
            managerValidated = false;
        }
        finally
        {
            isValidatingManager = false;
        }
    }

    // ========================================
    // PROCESS CANCELLATION
    // ========================================

    private async Task ProcessPrePaymentCancellation()
    {
        try
        {
            isProcessing = true;
            errorMessage = null;

            cancellationRequest.IsPrePaymentCancellation = true;
            cancellationResult = await TransactionService.ProcessCancellationAsync(cancellationRequest);

            currentStep = CancellationStep.Complete;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error processing cancellation: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task ProcessCancellation()
    {
        if (!CanProcessCancellation) return;

        try
        {
            isProcessing = true;
            errorMessage = null;

            cancellationResult = await TransactionService.ProcessCancellationAsync(cancellationRequest);

            currentStep = CancellationStep.Complete;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error processing cancellation: {ex.Message}";
            cancellationResult = new CancellationResultDto
            {
                Success = false,
                ErrorMessages = new List<string> { ex.Message }
            };
        }
        finally
        {
            isProcessing = false;
        }
    }
}
