@page "/barcode-scan-demo"
@using Microsoft.EntityFrameworkCore
@using Project420.Retail.POS.DAL
@using Project420.Retail.POS.Models.Entities
@using Project420.Shared.Core.Enums
@using Project420.Retail.POS.BLL.Services
@inject PosDbContext DbContext
@inject IPOSCalculationService CalculationService

<PageTitle>Barcode Scan Demo - Phase 1 POC</PageTitle>

<div class="container mt-4">
    <h1 class="mb-4">üõí Barcode Scanning Demo</h1>
    <p class="text-muted">Phase 1 Proof of Concept - Vertical Stack Demo</p>

    <div class="row">
        <!-- Barcode Input Section -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Scan Barcode</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="barcodeInput" class="form-label">Barcode Value</label>
                        <input @bind="barcodeInput"
                               @bind:event="oninput"
                               @onkeyup="HandleKeyUp"
                               id="barcodeInput"
                               type="text"
                               class="form-control"
                               placeholder="Scan or enter barcode..."
                               autofocus />
                    </div>
                    <button @onclick="ScanBarcode" class="btn btn-success w-100">
                        üîç Scan Barcode
                    </button>
                </div>
            </div>

            <!-- Sample Barcodes -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Sample Test Barcodes</h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted">Click to add test barcode to database:</p>
                    <button @onclick="() => AddSampleBarcode()" class="btn btn-sm btn-outline-primary mb-2 w-100">
                        Add Sample: Blue Dream (EAN13: 6001234567890)
                    </button>
                    <button @onclick="() => AddSampleSerialNumber()" class="btn btn-sm btn-outline-secondary w-100">
                        Add Sample: Serial Number (BD-2024-001-00042)
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="col-md-6">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger" role="alert">
                    <strong>Error:</strong> @errorMessage
                </div>
            }

            @if (scannedBarcode != null)
            {
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">‚úÖ Barcode Found</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <th>Barcode:</th>
                                <td>@scannedBarcode.BarcodeValue</td>
                            </tr>
                            <tr>
                                <th>Type:</th>
                                <td>@scannedBarcode.BarcodeType</td>
                            </tr>
                            <tr>
                                <th>Is Unique:</th>
                                <td>@(scannedBarcode.IsUnique ? "Yes (Serial Number)" : "No (Standard)")</td>
                            </tr>
                            @if (scannedBarcode.IsUnique)
                            {
                                <tr>
                                    <th>Serial Number:</th>
                                    <td>@scannedBarcode.SerialNumber</td>
                                </tr>
                                <tr>
                                    <th>Batch Number:</th>
                                    <td>@scannedBarcode.BatchNumber</td>
                                </tr>
                                <tr>
                                    <th>Sold:</th>
                                    <td class="@(scannedBarcode.IsSold ? "text-danger" : "text-success")">
                                        @(scannedBarcode.IsSold ? "‚ö†Ô∏è Already Sold" : "‚úÖ Available")
                                    </td>
                                </tr>
                            }
                        </table>
                    </div>
                </div>

                @if (scannedProduct != null)
                {
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">üì¶ Product Information</h5>
                        </div>
                        <div class="card-body">
                            <h6>@scannedProduct.Name</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>SKU:</th>
                                    <td>@scannedProduct.SKU</td>
                                </tr>
                                <tr>
                                    <th>Price (VAT incl):</th>
                                    <td class="text-success fw-bold">R @scannedProduct.Price.ToString("N2")</td>
                                </tr>
                                <tr>
                                    <th>Stock:</th>
                                    <td>@scannedProduct.StockOnHand units</td>
                                </tr>
                                @if (!string.IsNullOrEmpty(scannedProduct.StrainName))
                                {
                                    <tr>
                                        <th>Strain:</th>
                                        <td>@scannedProduct.StrainName</td>
                                    </tr>
                                    <tr>
                                        <th>THC/CBD:</th>
                                        <td>@scannedProduct.THCPercentage% THC / @scannedProduct.CBDPercentage% CBD</td>
                                    </tr>
                                }
                            </table>
                        </div>
                    </div>

                    <!-- VAT Calculation Demo -->
                    <div class="card">
                        <div class="card-header bg-warning">
                            <h6 class="mb-0">üßÆ POSCalculationService Demo</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Quantity:</label>
                                <input @bind="quantity" type="number" class="form-control" min="1" />
                            </div>
                            <button @onclick="CalculateLineItem" class="btn btn-warning w-100 mb-3">
                                Calculate Line Item
                            </button>

                            @if (calculatedLineItem != null)
                            {
                                <table class="table table-sm table-bordered">
                                    <tr>
                                        <th>Quantity:</th>
                                        <td>@calculatedLineItem.Quantity</td>
                                    </tr>
                                    <tr>
                                        <th>Unit Price:</th>
                                        <td>R @calculatedLineItem.UnitPrice.ToString("N2")</td>
                                    </tr>
                                    <tr class="table-light">
                                        <th>Subtotal (excl VAT):</th>
                                        <td>R @calculatedLineItem.Subtotal.ToString("N2")</td>
                                    </tr>
                                    <tr class="table-light">
                                        <th>VAT (15%):</th>
                                        <td>R @calculatedLineItem.TaxAmount.ToString("N2")</td>
                                    </tr>
                                    <tr class="table-success fw-bold">
                                        <th>Total (incl VAT):</th>
                                        <td>R @calculatedLineItem.Total.ToString("N2")</td>
                                    </tr>
                                </table>
                            }
                        </div>
                    </div>
                }
            }
        </div>
    </div>

    <!-- Database Stats -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">üìä Database Stats (Vertical Stack Verification)</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Products:</strong> @productCount
                        </div>
                        <div class="col-md-3">
                            <strong>Barcodes:</strong> @barcodeCount
                        </div>
                        <div class="col-md-3">
                            <strong>Standard Barcodes:</strong> @standardBarcodeCount
                        </div>
                        <div class="col-md-3">
                            <strong>Serial Numbers:</strong> @serialNumberCount
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string barcodeInput = string.Empty;
    private string errorMessage = string.Empty;
    private ProductBarcode? scannedBarcode;
    private Product? scannedProduct;
    private POSTransactionDetail? calculatedLineItem;
    private int quantity = 1;

    private int productCount = 0;
    private int barcodeCount = 0;
    private int standardBarcodeCount = 0;
    private int serialNumberCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadDatabaseStats();
    }

    private async Task LoadDatabaseStats()
    {
        productCount = await DbContext.Products.CountAsync();
        barcodeCount = await DbContext.ProductBarcodes.CountAsync();
        standardBarcodeCount = await DbContext.ProductBarcodes.CountAsync(b => !b.IsUnique);
        serialNumberCount = await DbContext.ProductBarcodes.CountAsync(b => b.IsUnique);
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await ScanBarcode();
        }
    }

    private async Task ScanBarcode()
    {
        errorMessage = string.Empty;
        scannedBarcode = null;
        scannedProduct = null;
        calculatedLineItem = null;

        if (string.IsNullOrWhiteSpace(barcodeInput))
        {
            errorMessage = "Please enter a barcode value";
            return;
        }

        try
        {
            // Query database for barcode (DAL layer)
            scannedBarcode = await DbContext.ProductBarcodes
                .Include(b => b.Product)
                .FirstOrDefaultAsync(b => b.BarcodeValue == barcodeInput.Trim());

            if (scannedBarcode == null)
            {
                errorMessage = $"Barcode '{barcodeInput}' not found in database";
                return;
            }

            // Check if serial number already sold
            if (scannedBarcode.IsUnique && scannedBarcode.IsSold)
            {
                errorMessage = $"This item was already sold on {scannedBarcode.SoldDate?.ToString("yyyy-MM-dd")} " +
                              $"(Transaction #{scannedBarcode.SoldInTransactionId})";
            }

            // Load product
            scannedProduct = scannedBarcode.Product;

            // Clear input for next scan
            barcodeInput = string.Empty;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error scanning barcode: {ex.Message}";
        }
    }

    private void CalculateLineItem()
    {
        if (scannedProduct == null) return;

        // Use POSCalculationService (BLL layer)
        calculatedLineItem = CalculationService.CalculateLineItem(scannedProduct.Price, quantity);
    }

    private async Task AddSampleBarcode()
    {
        try
        {
            // Check if barcode already exists
            var exists = await DbContext.ProductBarcodes.AnyAsync(b => b.BarcodeValue == "6001234567890");
            if (exists)
            {
                errorMessage = "Sample barcode already exists";
                return;
            }

            // Get a product to attach barcode to (or create one)
            var product = await DbContext.Products.FirstOrDefaultAsync();
            if (product == null)
            {
                errorMessage = "No products in database. Please seed data first.";
                return;
            }

            var barcode = new ProductBarcode
            {
                ProductId = product.Id,
                BarcodeValue = "6001234567890",
                BarcodeType = BarcodeType.EAN13,
                IsUnique = false,
                IsActive = true,
                IsPrimaryBarcode = true,
                CreatedAt = DateTime.UtcNow,
                CreatedBy = "DEMO"
            };

            await DbContext.ProductBarcodes.AddAsync(barcode);
            await DbContext.SaveChangesAsync();
            await LoadDatabaseStats();

            errorMessage = string.Empty;
            barcodeInput = "6001234567890";
            await ScanBarcode();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error adding sample barcode: {ex.Message}";
        }
    }

    private async Task AddSampleSerialNumber()
    {
        try
        {
            // Check if serial number already exists
            var exists = await DbContext.ProductBarcodes.AnyAsync(b => b.BarcodeValue == "BD-2024-001-00042");
            if (exists)
            {
                errorMessage = "Sample serial number already exists";
                return;
            }

            // Get a product to attach serial number to
            var product = await DbContext.Products.FirstOrDefaultAsync();
            if (product == null)
            {
                errorMessage = "No products in database. Please seed data first.";
                return;
            }

            var serialBarcode = new ProductBarcode
            {
                ProductId = product.Id,
                BarcodeValue = "BD-2024-001-00042",
                BarcodeType = BarcodeType.Code128,
                IsUnique = true,
                SerialNumber = "00042",
                BatchNumber = "BD-2024-001",
                IsSold = false,
                CreatedAt = DateTime.UtcNow,
                CreatedBy = "DEMO"
            };

            await DbContext.ProductBarcodes.AddAsync(serialBarcode);
            await DbContext.SaveChangesAsync();
            await LoadDatabaseStats();

            errorMessage = string.Empty;
            barcodeInput = "BD-2024-001-00042";
            await ScanBarcode();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error adding sample serial number: {ex.Message}";
        }
    }
}
