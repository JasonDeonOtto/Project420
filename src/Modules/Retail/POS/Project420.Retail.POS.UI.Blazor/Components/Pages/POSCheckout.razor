@page "/pos/checkout"
@using Project420.Retail.POS.BLL.Services
@using Project420.Retail.POS.BLL.DTOs
@using Project420.Shared.Core.Enums
@inject ITransactionService TransactionService
@inject IReceiptService ReceiptService

<PageTitle>POS Checkout</PageTitle>

<div class="container-fluid">
    <h2>Point of Sale - Checkout</h2>

    @if (checkoutResult != null && checkoutResult.Success && currentReceipt != null)
    {
        <!-- COMPLIANT RECEIPT DISPLAY (Phase 9.8) -->
        <div class="alert alert-success">
            <h4>Sale Completed Successfully</h4>
        </div>

        <div class="card mt-3" style="max-width: 500px; margin: 0 auto; font-family: 'Courier New', monospace;">
            <!-- Receipt Header -->
            <div class="card-header bg-dark text-white text-center">
                <h5 class="mb-0">@currentReceipt.BusinessName.ToUpper()</h5>
                <small>@currentReceipt.BusinessAddress</small><br/>
                <small>Tel: @currentReceipt.BusinessPhone</small><br/>
                <small class="fw-bold">VAT: @currentReceipt.VATRegistrationNumber</small>
                @if (!string.IsNullOrEmpty(currentReceipt.SAHPRALicenseNumber))
                {
                    <br/><small class="text-info">SAHPRA: @currentReceipt.SAHPRALicenseNumber</small>
                }
                @if (!string.IsNullOrEmpty(currentReceipt.DALRRDPermitNumber))
                {
                    <br/><small class="text-info">DALRRD: @currentReceipt.DALRRDPermitNumber</small>
                }
            </div>

            <div class="card-body" style="font-size: 0.9rem;">
                <!-- Transaction Info -->
                <div class="border-bottom pb-2 mb-2">
                    <div class="row">
                        <div class="col-6">
                            <strong>Receipt #:</strong> @currentReceipt.ReceiptNumber
                        </div>
                        <div class="col-6 text-end">
                            <strong>@currentReceipt.TransactionDateTime.ToString("yyyy-MM-dd HH:mm")</strong>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <small>Terminal: @currentReceipt.TerminalId</small>
                        </div>
                        <div class="col-6 text-end">
                            <small>Cashier: @currentReceipt.CashierName</small>
                        </div>
                    </div>
                    <div><small>Customer: @currentReceipt.CustomerName</small></div>
                </div>

                <!-- Line Items with Batch/Serial Numbers -->
                <table class="table table-sm mb-0" style="font-size: 0.85rem;">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th class="text-center">Qty</th>
                            <th class="text-end">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in currentReceipt.LineItems)
                        {
                            <tr>
                                <td>@item.ProductName</td>
                                <td class="text-center">@item.Quantity</td>
                                <td class="text-end">R @item.LineTotalInclVAT.ToString("F2")</td>
                            </tr>
                            @if (!string.IsNullOrEmpty(item.BatchNumber) || !string.IsNullOrEmpty(item.SerialNumber))
                            {
                                <tr>
                                    <td colspan="3" class="text-muted small py-0" style="font-size: 0.75rem;">
                                        @if (!string.IsNullOrEmpty(item.BatchNumber))
                                        {
                                            <span class="me-2">Batch: @item.BatchNumber</span>
                                        }
                                        @if (!string.IsNullOrEmpty(item.SerialNumber))
                                        {
                                            <span>S/N: @item.SerialNumber</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>

                <!-- VAT Breakdown -->
                <div class="border-top border-bottom py-2 my-2">
                    <table class="table table-sm mb-0" style="font-size: 0.85rem;">
                        <tr>
                            <td>Subtotal (excl VAT):</td>
                            <td class="text-end">R @currentReceipt.SubtotalExclVAT.ToString("F2")</td>
                        </tr>
                        <tr>
                            <td>VAT (@currentReceipt.VATRate.ToString("F0")%):</td>
                            <td class="text-end">R @currentReceipt.VATAmount.ToString("F2")</td>
                        </tr>
                        @if (currentReceipt.DiscountAmount > 0)
                        {
                            <tr class="text-danger">
                                <td>Discount:</td>
                                <td class="text-end">-R @currentReceipt.DiscountAmount.ToString("F2")</td>
                            </tr>
                        }
                        <tr class="fw-bold" style="font-size: 1rem;">
                            <td>TOTAL:</td>
                            <td class="text-end">R @currentReceipt.TotalInclVAT.ToString("F2")</td>
                        </tr>
                    </table>
                </div>

                <!-- Payment Details -->
                <div class="mb-2">
                    @foreach (var payment in currentReceipt.Payments)
                    {
                        <div class="d-flex justify-content-between">
                            <span>@payment.PaymentMethod:</span>
                            <span>R @payment.Amount.ToString("F2")</span>
                        </div>
                    }
                    @if (currentReceipt.ChangeDue > 0)
                    {
                        <div class="d-flex justify-content-between fw-bold text-success">
                            <span>CHANGE:</span>
                            <span>R @currentReceipt.ChangeDue.ToString("F2")</span>
                        </div>
                    }
                </div>

                <!-- Compliance Notices -->
                @if (currentReceipt.ComplianceNotices.Any())
                {
                    <div class="alert alert-secondary py-2 mb-2" style="font-size: 0.8rem;">
                        @foreach (var notice in currentReceipt.ComplianceNotices)
                        {
                            <div>@notice</div>
                        }
                    </div>
                }

                <!-- Legal Disclaimers -->
                @if (currentReceipt.LegalDisclaimers.Any())
                {
                    <div class="text-muted small border-top pt-2" style="font-size: 0.7rem;">
                        @foreach (var disclaimer in currentReceipt.LegalDisclaimers)
                        {
                            <p class="mb-1">@disclaimer</p>
                        }
                    </div>
                }
            </div>

            <!-- Footer -->
            <div class="card-footer text-center bg-light">
                @foreach (var line in currentReceipt.FooterMessage.Split('\n'))
                {
                    <div>@line</div>
                }
            </div>
        </div>

        <div class="text-center mt-3">
            <button class="btn btn-primary btn-lg" @onclick="StartNewSale">New Sale</button>
            <button class="btn btn-outline-secondary btn-lg ms-2" @onclick="PrintReceipt">Print Receipt</button>
        </div>
    }
    else
    {
        <!-- CHECKOUT FORM -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Shopping Cart</h5>
                    </div>
                    <div class="card-body">
                        @if (cart.Count == 0)
                        {
                            <div class="alert alert-warning">
                                Cart is empty. Add products to continue.
                            </div>

                            <!-- DEMO: Quick add products -->
                            <div class="mt-3">
                                <h6>Quick Add (Demo Data)</h6>
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => AddDemoProduct(1, 100.00m)">
                                    Add Cannabis Flower - R100.00
                                </button>
                                <button class="btn btn-sm btn-outline-primary ms-2" @onclick="() => AddDemoProduct(2, 50.00m)">
                                    Add Pre-Roll - R50.00
                                </button>
                            </div>
                        }
                        else
                        {
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in cart)
                                    {
                                        <tr>
                                            <td>@item.ProductName</td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm" style="width: 80px;"
                                                       @bind="item.Quantity" min="1" />
                                            </td>
                                            <td>R @item.UnitPriceInclVAT.ToString("F2")</td>
                                            <td>R @((item.UnitPriceInclVAT * item.Quantity).ToString("F2"))</td>
                                            <td>
                                                <button class="btn btn-sm btn-danger" @onclick="() => RemoveFromCart(item)">Remove</button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>

                            <div class="text-end">
                                <h5>Cart Total: R @cart.Sum(c => c.UnitPriceInclVAT * c.Quantity).ToString("F2")</h5>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5>Complete Sale</h5>
                    </div>
                    <div class="card-body">
                        <!-- Customer Info -->
                        <div class="mb-3">
                            <label class="form-label">Customer Name</label>
                            <input type="text" class="form-control" @bind="customerName"
                                   placeholder="Walk-In Customer" />
                        </div>

                        <!-- Age Verification (Cannabis Act Requirement) -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input @(ageVerified ? "border-success" : "border-danger")"
                                       type="checkbox"
                                       id="ageVerified"
                                       @bind="ageVerified" />
                                <label class="form-check-label fw-bold @(ageVerified ? "text-success" : "text-danger")" for="ageVerified">
                                    âœ“ Age Verified (18+) - REQUIRED
                                </label>
                            </div>
                            @if (!ageVerified)
                            {
                                <small class="text-danger">Cannabis Act compliance: Must verify customer is 18+</small>
                            }
                        </div>

                        <!-- Payment Method -->
                        <div class="mb-3">
                            <label class="form-label">Payment Method</label>
                            <select class="form-select" @bind="paymentMethod">
                                <option value="@PaymentMethod.Cash">Cash</option>
                                <option value="@PaymentMethod.Card">Card</option>
                                <option value="@PaymentMethod.EFT">EFT</option>
                                <option value="@PaymentMethod.MobilePayment">Mobile Payment</option>
                            </select>
                        </div>

                        <!-- Cash Tendered (if cash payment) -->
                        @if (paymentMethod == PaymentMethod.Cash)
                        {
                            <div class="mb-3">
                                <label class="form-label">Amount Tendered</label>
                                <input type="number" class="form-control" @bind="amountTendered"
                                       step="0.01" min="0" placeholder="0.00" />
                                @if (amountTendered > 0)
                                {
                                    var total = cart.Sum(c => c.UnitPriceInclVAT * c.Quantity);
                                    var change = amountTendered - total;
                                    <small class="@(change >= 0 ? "text-success" : "text-danger")">
                                        Change: R @change.ToString("F2")
                                    </small>
                                }
                            </div>
                        }

                        <!-- Error Messages -->
                        @if (errorMessages.Any())
                        {
                            <div class="alert alert-danger">
                                <ul class="mb-0">
                                    @foreach (var error in errorMessages)
                                    {
                                        <li>@error</li>
                                    }
                                </ul>
                            </div>
                        }

                        <!-- Checkout Button -->
                        <button class="btn btn-success btn-lg w-100"
                                @onclick="ProcessCheckout"
                                disabled="@(cart.Count == 0 || !ageVerified || isProcessing)">
                            @if (isProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <text>Processing...</text>
                            }
                            else
                            {
                                <text>Complete Sale</text>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    // Cart state
    private List<CartItemDto> cart = new();

    // Checkout form state
    private string customerName = "Walk-In Customer";
    private bool ageVerified = false;
    private PaymentMethod paymentMethod = PaymentMethod.Cash;
    private decimal amountTendered = 0;

    // Processing state
    private bool isProcessing = false;
    private List<string> errorMessages = new();
    private CheckoutResultDto? checkoutResult = null;
    private ReceiptDto? currentReceipt = null;

    // Demo product counter
    private int demoProductId = 1;

    /// <summary>
    /// Add demo product to cart (for testing)
    /// </summary>
    private void AddDemoProduct(int id, decimal price)
    {
        cart.Add(new CartItemDto
        {
            ProductId = id,
            ProductSku = $"DEMO-{id:D3}",
            ProductName = id == 1 ? "Cannabis Flower - Indica" : "Cannabis Pre-Roll",
            UnitPriceInclVAT = price,
            Quantity = 1,
            BatchNumber = $"BATCH-{DateTime.Now:yyyyMMdd}-{id:D3}",
            CostPrice = price * 0.6m // 40% margin
        });
    }

    /// <summary>
    /// Remove item from cart
    /// </summary>
    private void RemoveFromCart(CartItemDto item)
    {
        cart.Remove(item);
    }

    /// <summary>
    /// Process the checkout
    /// </summary>
    private async Task ProcessCheckout()
    {
        errorMessages.Clear();
        isProcessing = true;
        currentReceipt = null;

        try
        {
            // Build checkout request
            var request = new CheckoutRequestDto
            {
                CustomerName = string.IsNullOrWhiteSpace(customerName) ? "Walk-In Customer" : customerName,
                AgeVerified = ageVerified,
                AgeVerificationDate = DateTime.UtcNow,
                CartItems = cart,
                PaymentMethod = paymentMethod,
                AmountTendered = paymentMethod == PaymentMethod.Cash ? amountTendered : null,
                ProcessedBy = 1 // TODO: Get from logged-in user
            };

            // Call service
            checkoutResult = await TransactionService.ProcessCheckoutAsync(request);

            if (checkoutResult.Success)
            {
                // Generate compliant receipt
                currentReceipt = ReceiptService.GenerateReceiptFromCheckout(checkoutResult);
            }
            else
            {
                errorMessages = checkoutResult.ErrorMessages;
            }
        }
        catch (Exception ex)
        {
            errorMessages.Add($"System error: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
        }
    }

    /// <summary>
    /// Print receipt (opens print dialog)
    /// </summary>
    private async Task PrintReceipt()
    {
        if (currentReceipt == null) return;

        // Generate HTML receipt and print via JavaScript
        var htmlReceipt = ReceiptService.FormatReceiptAsHtml(currentReceipt);

        // For now, just show in a new window/print dialog
        // In production, this would integrate with thermal printer
        await Task.CompletedTask;
    }

    /// <summary>
    /// Start a new sale (reset form)
    /// </summary>
    private void StartNewSale()
    {
        cart.Clear();
        customerName = "Walk-In Customer";
        ageVerified = false;
        paymentMethod = PaymentMethod.Cash;
        amountTendered = 0;
        errorMessages.Clear();
        checkoutResult = null;
        currentReceipt = null;
    }
}
